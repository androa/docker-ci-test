version: 2.1

executors:
  builder_java:
    docker:
      - image: openjdk:11-jdk-slim

  builder-docker:
    docker:
      - image: docker:stable

  toolbox:
    docker:
      - image: alpine:latest

jobs:
  build-jar:
    executor: builder_java
    steps:
      - checkout
      - run: echo true

  build-docker:
    executor: builder-docker
    steps:
      - run: docker build .

  prepare-nais:
    executor: toolbox
    steps:
      - run: echo true

  deploy-preprod:
    executor: toolbox
    environment:
      FOO: bar
    steps:
      - run: echo true

  acceptance-test-uat:
    executor: toolbox
    steps:
      - run: echo true

  acceptance-test-integration:
    executor: toolbox
    steps:
      - run: echo true

  acceptance-test-benchmark:
    executor: toolbox
    steps:
      - run: echo true

  deploy:
    executor: toolbox
    environment:
      FOO: bar
    steps:
      - run: kubectl

workflows:
  version: 2.1
  build-and-deploy:
    jobs:
      - build:
        requires:
          - build-jar
          - build-docker
          - prepare-nais
      - deploy-preprod:
        requires:
          - build
          - prepare-nais
        filters:
          branches:
            only: master
      - acceptance-test-uat:
        requires:
          - deploy-preprod
      - acceptance-test-integration:
        requires:
          - deploy-preprod
      - acceptance-test-benchmark:
        requires:
          - deploy-preprod
      - deploy:
        requires:
          - prepare-nais
          - acceptance-test-uat
          - acceptance-test-integration
          - acceptance-test-benchmark
        filters:
          branches:
            only: master
